<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <script   src="https://code.jquery.com/jquery-3.3.1.js"   integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60="   crossorigin="anonymous"></script>
    <link rel="stylesheet" href="assets/css/style.css">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="https://www.gstatic.com/firebasejs/4.11.0/firebase.js"></script>
    <title>Casey Jones</title>
</head>
<body>
    <div class="container">
        <div class="jumbotron text-center">
            Train Schedule
        </div>
    </div>
    <div class="row" id="trainarrivaltext">Train Arrivals</div>
    <div class="row" id="trainarrivaldiv">
        <table class="table">
            <thead>
                <tr>
                <th scope="col">Train Number</th>
                <th scope="col">Train Name</th>
                <th scope="col">Destination</th>
                <th scope="col">Frequency</th>
                <th scope="col">Next Arrival</th>
                <th scope="col">Minutes Away</th>
                </tr>
            </thead>
            <tbody id="tablebody">
            </tbody>
        </table>
    </div>    
    <div class="row" id="addtraintext">Add a Train</div>
    <div class="row" id="addtraindiv">
        Train Name: <br>
        <input type="text" name="trainname" id="trainname"><br>
        Destination: <br>
        <input type="text" name="destination" id="destination"><br>
        First Train Time (hh:mm-military time): <br>
        <input type="text" name="firsttraintime" id="firsttraintime"><br>
        Frequency (min): <br> 
        <input type="text" name="frequency" id="frequency"><br><br>
        <input type="submit" name="submitbutton" id="submit">
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.21.0/moment.js"></script>
    <script>
        // Initialize Firebase
        var config = {
        apiKey: "AIzaSyBujkiz995urKQHvDC42hrsUKNzV9OdcEM",
        authDomain: "johnny-demo.firebaseapp.com",
        databaseURL: "https://johnny-demo.firebaseio.com",
        projectId: "johnny-demo",
        storageBucket: "johnny-demo.appspot.com",
        messagingSenderId: "1079768860694"
        };

  firebase.initializeApp(config);
        
        var train 
        var name
        var destination
        var frequency
        var nextOne
        var minsAway
        var diffTime
        var firstTimeConverted
        var firstTrain
        var database = firebase.database()
        var trainNumber
        var dbName
        var dbDest
        var dbFirstTrain
        var dbFreq
        var dbTrainNumber = 0
        var timer
        var dbSnapshot

        // event listener to push data to the table when a change is made to the database
        timer = setInterval(updateTable, 60000)  
        function updateTable() {
            $("#tablebody").empty()
            database.ref().on("child_added", function(snapshot){
 
                if (typeof snapshot != "undefined") {
                    dbSnapshot = snapshot
                }    
                dbName = dbSnapshot.val().name;
                dbDest = dbSnapshot.val().destination;
                dbFirstTrain = moment(dbSnapshot.val().firstTrain, "HH:mm");
                dbFreq = dbSnapshot.val().frequency;
                dbTrainNumber = dbSnapshot.val().trainNumber;
                
                frequency = parseInt(dbFreq)
                console.log("frequency: " + frequency)

                firstTimeConverted = moment(dbFirstTrain, "HH:mm").subtract(1, "days")
                console.log("firstTimeConverted: " + firstTimeConverted)

                diffTime = moment().diff(moment(firstTimeConverted), "minutes")
                console.log("diffTime: " + diffTime)

                minsAway = diffTime % frequency
                console.log("minsAway: " + minsAway)

                minsAway = frequency - minsAway 

                nextOne = moment().add(minsAway, "minutes")
                console.log("nextOne: " + nextOne)

                //adding the new records to the table
                $("#tablebody").append(`<tr><td>${dbTrainNumber}</td><td>${dbName}</td><td>${dbDest}</td><td>${dbFreq}</td><td>${nextOne}</td><td>${minsAway}</td></tr>`);
                
                // timer = setInterval(updateTable, 5000)
            })
        }
        updateTable()
        timer = setInterval(updateTable, 60000)
        // timer = setInterval(updateTable, 60000)    

        // event listener to take user input data and push it to the database
        $("#submit").on("click", function(){
                train = {
                    destination: $("#destination").val(),
                    firstTrain: $("#firsttraintime").val(),
                    frequency: $("#frequency").val(),
                    name: $("#trainname").val(),
                    trainNumber: dbTrainNumber + 1,
                }
                
                $("#trainname").val("")
                $("#destination").val("")
                $("#firsttraintime").val("")
                $("#frequency").val("")

                //passing the trains array to firebase
                database.ref().push(train)

        })
        // })

    </script>
</body>
</html>

